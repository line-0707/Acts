<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ИНФОРМАЦИОННАЯ САЙТА</title>
  <link rel="icon" type="image/x-icon" href="https://line-0707.github.io/Acts/favicon.ico">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root {
      --bg-color: #f4f4f9;
      --text-color: #333;
      --text-color-subtle: #888;
      --card-bg-color: #fff;
      --border-color: #ccc;
      --header-bg-color: #007bff;
      --hover-bg-color: #e9ecef;
      --even-row-bg-color: #f8f9fa;
      --category-bg-color: #6c757d;
      --category-hover-bg-color: #5a626a;
    }

    .dark-mode {
      --bg-color: #181818;
      --text-color: #e0e0e0;
      --text-color-subtle: #aaa;
      --card-bg-color: #282828;
      --border-color: #444;
      --hover-bg-color: #383838;
      --even-row-bg-color: #303030;
      --category-bg-color: #495057;
      --category-hover-bg-color: #5c636a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .content-wrapper {
      max-width: 1280px;
      margin: 0 auto;
    }

    .top-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      position: absolute;
      top: 20px;
      right: 20px;
    }

    #theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--card-bg-color);
      border: none;
      padding: 8px;
      aspect-ratio: 1 / 1;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: background-color 0.2s;
    }

    #theme-toggle .material-symbols-outlined {
      color: var(--text-color);
    }

    #theme-toggle:hover {
      background-color: var(--hover-bg-color);
    }

    .lang-switcher {
      display: flex;
      gap: 5px;
      background-color: var(--card-bg-color);
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .lang-switcher button {
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background-color: transparent;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
      color: #007bff;
      border-radius: 5px;
      transition: background-color 0.2s, color 0.2s;
    }

    .lang-switcher button:hover {
      background-color: var(--hover-bg-color);
    }

    .lang-switcher button.active {
      background-color: #007bff;
      color: white;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .header img {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      border-radius: 50%;
      object-fit: cover;
    }

    .header h1,
    .header h2 {
      margin: 0;
    }

    .header h1 {
      font-size: 2em;
    }

    .header h1 a {
      text-decoration: none;
      color: inherit;
    }

    .header h2 {
      font-size: 1.2em;
      font-weight: normal;
      color: var(--text-color-subtle);
    }

    #table-container {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      background-color: var(--card-bg-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      display: table;
    }

    thead,
    tbody {
      display: block;
    }

    tr {
      display: flex;
      align-items: stretch;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      white-space: normal;
      word-break: break-word;
      display: flex;
      align-items: center;
    }

    .th-files,
    .td-files {
      flex: 1 1 auto;
    }

    .th-description,
    .td-description {
      flex: 0 1 25%;
    }

    .th-date,
    .td-date {
      flex: 0 0 16%;
    }

    .th-status,
    .td-status {
      flex: 0 0 18%;
    }

    .th-last_update,
    .td-last_update {
      flex: 0 0 20%;
      order: 99;
    }

    thead th {
      background-color: var(--header-bg-color);
      color: white;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: var(--even-row-bg-color);
    }

    tbody tr:hover {
      background-color: var(--hover-bg-color);
    }

    .category-row {
      display: block;
    }

    .category-row td {
      background-color: var(--category-bg-color);
      color: white;
      font-weight: bold;
      width: 100%;
      box-sizing: border-box;
    }

    tr.category-row:hover td {
      background-color: var(--category-hover-bg-color);
    }

    table a {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    table a:hover {
      text-decoration: underline;
    }

    .loader {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
    }

    .status-bullet-mobile {
      display: none;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: var(--text-color-subtle);
      font-size: 0.9em;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        flex-direction: column;
        align-items: center;
        margin-top: 50px;
      }

      .header img {
        margin-right: 0;
        margin-bottom: 10px;
      }

      .header div {
        text-align: center;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .header h2 {
        font-size: 1.1em;
      }

      .top-controls {
        position: static;
        width: 100%;
        justify-content: flex-end;
        margin-bottom: 20px;
        order: -1;
      }

      .status-text,
      .th-status,
      .td-status {
        display: none;
      }

      .status-bullet-mobile {
        display: inline;
        font-weight: bold;
      }

      .th-files,
      .td-files {
        flex: 1 1 auto;
      }

      .th-date,
      .td-date {
        flex: 0 0 25%;
      }

      .th-description,
      .td-description {
        flex: 0 0 15%;
      }

      .th-last_update,
      .td-last_update {
        flex: 0 0 30%;
        order: 99;
      }
    }
  </style>
</head>

<body>

  <div class="content-wrapper">

    <div class="top-controls">
      <button id="theme-toggle" class="control-button" title="Toggle theme"></button>
      <div class="lang-switcher">
        <button data-lang="ru" class="control-button active">RU</button>
        <button data-lang="en" class="control-button">EN</button>
        <button data-lang="ja" class="control-button">JP</button>
      </div>
    </div>

    <div class="header">
      <a href="https://line-0707.github.io/Acts/index.html">
        <img src="https://line-0707.github.io/Acts/source/icon.webp" alt="Site Icon">
      </a>
      <div>
        <h1><a href="https://line-0707.github.io/Acts/index.html" id="site-title">ИНФОРМАЦИОННАЯ САЙТА</a></h1>
        <h2 id="site-subtitle">Сводка опубликованных документов и ресурсов</h2>
      </div>
    </div>

    <div id="table-container">
      <div class="loader">Loading data from Google Sheet...</div>
    </div>

    <footer>
      <p id="last-updated"></p>
    </footer>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1Rvr4RwirK8-ygKXG3Qyq6Bf4OvGZ7YjsxiAb4ZI2Xeo/gviz/tq?tqx=out:csv&sheet=Лист1';

    const translations = {
      ru: {
        title: 'ИНФОРМАЦИОННАЯ САЙТА',
        subtitle: 'Сводка опубликованных документов и ресурсов',
        headers: { date: 'дата', files: 'файлы', description: 'описание', status: 'статус', last_update: 'последнее обновление' },
        status_text: { g: 'Доступен', ex: 'Истек срок', e: 'В разработке' },
        months_short: ['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'],
        last_updated: 'Последнее обновление сайта:'
      },
      en: {
        title: 'INFORMATION SITE',
        subtitle: 'Summary of published documents and resources',
        headers: { date: 'date', files: 'files', description: 'description', status: 'status', last_update: 'last update' },
        status_text: { g: 'Available', ex: 'Expired', e: 'Incomplete' },
        months_short: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        last_updated: 'Site last updated:'
      },
      ja: {
        title: '情報サイト',
        subtitle: '公開されたドキュメントとリソースの概要',
        headers: { date: '日付', files: 'ファイル', description: '説明', status: '状態', last_update: '最終更新' },
        status_text: { g: '利用可能', ex: '期限切れ', e: '未完成' },
        last_updated: 'サイト最終更新日時:'
      }
    };

    let fullData = [];
    let columnIndices = {};
    let visibleHeadersInfo = [];
    const columnsToHide = new Set(['en', 'jp', 'link', 'desc_en', 'desc_ja']);
    let fileLastModifiedDate = null;

    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;

    function applyTheme(theme) {
      const iconName = theme === 'dark' ? 'light_mode' : 'dark_mode';
      if (theme === 'dark') { body.classList.add('dark-mode'); }
      else { body.classList.remove('dark-mode'); }
      themeToggle.innerHTML = `<span class="material-symbols-outlined">${iconName}</span>`;
    }

    themeToggle.addEventListener('click', () => {
      const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
    });

    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

    function parseCSV(csvText) {
      const lines = csvText.replace(/\r\n/g, '\n').split('\n');
      return lines.map(line => {
        const row = [];
        let cell = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"' && inQuotes) {
            if (i + 1 < line.length && line[i + 1] === '"') { cell += '"'; i++; } else { inQuotes = false; }
          } else if (char === '"' && !inQuotes) {
            inQuotes = true;
          } else if (char === ',' && !inQuotes) {
            row.push(cell); cell = '';
          } else { cell += char; }
        }
        row.push(cell);
        return row;
      });
    }

    function normalizeHeader(header) { return (header || '').trim().replace(/^"|"$/g, '').toLowerCase(); }

    // --- ここからが修正点です ---
    function formatDate(dateString, lang, useShort = false, isMobile = false) {
      if (!dateString) return dateString;
      let date;
      if (/^\d{8}$/.test(dateString)) {
        const year = dateString.substring(0, 4), month = dateString.substring(4, 6), day = dateString.substring(6, 8);
        date = new Date(year, month - 1, day);
      } else { date = new Date(dateString.replace(/(\d+)\.(\d+)\.(\d+)/, '$2/$1/$3')); }

      if (isNaN(date.getTime())) { return dateString; }

      if (lang === 'ja') {
        const options = { era: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const fullWarekiDate = new Intl.DateTimeFormat('ja-JP-u-ca-japanese', options).format(date);

        if (isMobile) {
          const eraAbbreviations = { '令和': 'R', '平成': 'H', '昭和': 'S', '大正': 'T', '明治': 'M' };
          for (const [era, abbr] of Object.entries(eraAbbreviations)) {
            if (fullWarekiDate.startsWith(era)) {
              return fullWarekiDate.replace(era, abbr);
            }
          }
        }
        return fullWarekiDate;
      }

      const year = date.getFullYear(), monthIndex = date.getMonth(), day = date.getDate();
      const monthArray = useShort ? translations[lang].months_short : translations[en].months_short; // Fallback to English

      switch (lang) {
        case 'ru': return `${day} ${monthArray[monthIndex]} ${year}г.`;
        case 'en': return `${monthArray[monthIndex]} ${day}, ${year}`;
        default: return dateString;
      }
    }
    // --- ここまで ---

    function getStatusConfig(statusCode, lang, isDarkMode) {
      let config = null;
      switch (statusCode) {
        case 'g':
          config = { text: translations[lang].status_text.g, bgColor: '#d1fae5', color: '#065f46', bulletColor: '#16a34a' };
          if (isDarkMode) config.bgColor = '#052e16';
          break;
        case 'ex':
          config = { text: translations[lang].status_text.ex, bgColor: '#fecaca', color: '#991b1b', bulletColor: '#dc2626' };
          if (isDarkMode) config.bgColor = '#450a0a';
          break;
        case 'e':
          config = { text: translations[lang].status_text.e, bgColor: '#fef9c3', color: '#92400e', bulletColor: '#f59e0b' };
          if (isDarkMode) config.bgColor = '#451a03';
          break;
      }
      return config;
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.addEventListener('click', () => renderPage(button.dataset.lang));
      });
      fetchAndRender();
    });

    function fetchAndRender() {
      const dataPromise = fetch(sheetUrl).then(res => res.ok ? res.text() : Promise.reject('Data fetch failed'));
      const headersPromise = fetch(window.location.href, { method: 'HEAD' })
        .then(res => {
          if (res.ok && res.headers.has('Last-Modified')) {
            fileLastModifiedDate = new Date(res.headers.get('Last-Modified'));
          }
        });

      Promise.all([dataPromise, headersPromise])
        .then(([csvText]) => {
          fullData = parseCSV(csvText);
          if (fullData.length < 1) throw new Error('No data found');
          const firstRowRaw = fullData[0];
          if (firstRowRaw.length > 0 && firstRowRaw.some(cell => cell.includes('cat['))) {
            const correctedHeaders = [], correctedFirstDataRow = [];
            firstRowRaw.forEach(cellContent => {
              const catIndex = cellContent.indexOf('cat[');
              if (catIndex !== -1) {
                correctedHeaders.push(cellContent.substring(0, catIndex).trim());
                correctedFirstDataRow.push(cellContent.substring(catIndex).trim());
              } else {
                const spaceIndex = cellContent.indexOf(' ');
                if (spaceIndex !== -1) {
                  correctedHeaders.push(cellContent.substring(0, spaceIndex).trim());
                  correctedFirstDataRow.push(cellContent.substring(spaceIndex + 1).trim());
                } else {
                  correctedHeaders.push(cellContent.trim());
                  correctedFirstDataRow.push('');
                }
              }
            });
            fullData.shift(); fullData.unshift(correctedFirstDataRow); fullData.unshift(correctedHeaders);
          }
          const headers = fullData[0];
          console.log("最終的に認識されたヘッダー名:", headers.map(h => normalizeHeader(h)));
          headers.forEach((header, index) => { columnIndices[normalizeHeader(header)] = index; });
          visibleHeadersInfo = headers.map((header, index) => ({ header, index })).filter(h => !columnsToHide.has(normalizeHeader(h.header)));
          renderPage(document.documentElement.lang || 'ru');
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('table-container').textContent = 'Error: Could not load data. Ensure the Google Sheet is "Published to the web" as a CSV.';
        });
    }

    function renderPage(lang) {
      document.getElementById('site-title').textContent = translations[lang].title;
      document.getElementById('site-subtitle').textContent = translations[lang].subtitle;
      document.documentElement.lang = lang;
      const isMobile = window.innerWidth <= 768;
      const isDarkMode = body.classList.contains('dark-mode');
      document.querySelectorAll('.lang-switcher button').forEach(button => { button.classList.toggle('active', button.dataset.lang === lang); });
      const tableContainer = document.getElementById('table-container');
      tableContainer.innerHTML = '';
      const table = document.createElement('table'), thead = document.createElement('thead'), tbody = document.createElement('tbody');
      const headerRow = document.createElement('tr');
      const translatedHeaders = translations[lang].headers;
      visibleHeadersInfo.forEach(({ header }) => {
        const th = document.createElement('th'), normalizedHeader = normalizeHeader(header);
        th.className = 'th-' + normalizedHeader;
        th.textContent = translatedHeaders[normalizedHeader] || header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      for (let i = 1; i < fullData.length; i++) {
        const rowData = fullData[i];
        if (rowData.length <= 1 && !(rowData[0] || '').trim()) continue;
        let fileCellText = '';
        const ruFileText = (rowData[columnIndices['files']] || '').trim();
        if (lang === 'en') {
          fileCellText = (rowData[columnIndices['en']] || ruFileText).trim();
        } else if (lang === 'ja') {
          fileCellText = (rowData[columnIndices['jp']] || ruFileText).trim();
        } else { fileCellText = ruFileText; }
        if (fileCellText.startsWith('cat[')) {
          const match = fileCellText.match(/\[(.*?)\]/);
          if (match) {
            const tr = document.createElement('tr');
            tr.className = 'category-row';
            const td = document.createElement('td');
            td.colSpan = visibleHeadersInfo.length; td.textContent = match[1];
            tr.appendChild(td); tbody.appendChild(tr);
          }
        } else {
          const tr = document.createElement('tr');
          const linkUrl = (rowData[columnIndices['link']] || '').trim();
          const statusCode = (rowData[columnIndices['status']] || '').trim().toLowerCase();
          const statusConfig = getStatusConfig(statusCode, lang, isDarkMode);
          visibleHeadersInfo.forEach(({ header, index }) => {
            const td = document.createElement('td');
            let cellText;
            const normalizedHeader = normalizeHeader(header);
            td.className = 'td-' + normalizedHeader;
            if (normalizedHeader === 'files') {
              cellText = fileCellText;
            } else if (normalizedHeader === 'description') {
              const ruDescText = (rowData[columnIndices['description']] || '').trim();
              if (lang === 'en') cellText = (rowData[columnIndices['desc_en']] || ruDescText).trim();
              else if (lang === 'ja') cellText = (rowData[columnIndices['desc_ja']] || ruDescText).trim();
              else cellText = ruDescText;
            } else if (normalizedHeader === 'status') {
              if (statusConfig) {
                const bulletSpan = document.createElement('span'); bulletSpan.textContent = '● '; bulletSpan.style.color = statusConfig.bulletColor;
                const textSpan = document.createElement('span'); textSpan.className = 'status-text'; textSpan.textContent = statusConfig.text; textSpan.style.fontWeight = 'bold';
                td.appendChild(bulletSpan); td.appendChild(textSpan);
                td.style.backgroundColor = statusConfig.bgColor; td.style.color = statusConfig.color;
              } else { td.textContent = (rowData[index] || '').trim(); }
              tr.appendChild(td); return;
            } else if (normalizedHeader === 'last_update') {
              cellText = formatDate((rowData[index] || '').trim(), lang, true, isMobile);
            } else { cellText = formatDate((rowData[index] || '').trim(), lang, false, isMobile); }
            if (normalizedHeader === 'files') {
              const contentWrapper = document.createDocumentFragment();
              if (statusConfig) {
                const bulletSpan = document.createElement('span'); bulletSpan.className = 'status-bullet-mobile'; bulletSpan.textContent = '● '; bulletSpan.style.color = statusConfig.bulletColor;
                contentWrapper.appendChild(bulletSpan);
              }
              const a = document.createElement('a');
              a.textContent = cellText;
              if (linkUrl) { a.href = linkUrl; a.target = '_blank'; a.rel = 'noopener noreferrer'; }
              contentWrapper.appendChild(a);
              td.appendChild(contentWrapper);
            } else { td.textContent = cellText; }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      }
      table.appendChild(thead); table.appendChild(tbody);
      tableContainer.appendChild(table);

      if (fileLastModifiedDate) {
        const locale = lang === 'ja' ? 'ja-JP-u-ca-japanese' : `${lang}-${lang.toUpperCase()}`;
        const dateTimeOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const formattedDateTime = new Intl.DateTimeFormat(locale, dateTimeOptions).format(fileLastModifiedDate);
        document.getElementById('last-updated').textContent = `${translations[lang].last_updated} ${formattedDateTime}`;
      }
    }
  </script>

</body>

</html>