<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ИНФОРМАЦИОННАЯ САЙТА</title>
  <link rel="icon" type="image/x-icon" href="https://line-0707.github.io/Acts/favicon.ico">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
      color: #333;
      position: relative;
    }

    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 5px;
      background-color: #fff;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .lang-switcher button {
      border: none;
      background-color: transparent;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
      color: #007bff;
      border-radius: 5px;
      transition: background-color 0.2s, color 0.2s;
    }

    .lang-switcher button:hover {
      background-color: #e9ecef;
    }

    .lang-switcher button.active {
      background-color: #007bff;
      color: white;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .header img {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }

    .header h1,
    .header h2 {
      margin: 0;
    }

    .header h1 {
      font-size: 2em;
    }

    .header h1 a {
      text-decoration: none;
      color: inherit;
    }

    .header h2 {
      font-size: 1.2em;
      font-weight: normal;
      color: #555;
    }

    #table-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      background-color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }

    thead th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    tbody tr:hover {
      background-color: #e9ecef;
    }

    .category-row {
      background-color: #6c757d;
      color: white;
      font-weight: bold;
      text-align: center !important;
    }

    .category-row:hover {
      background-color: #5a6268;
    }

    table a {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    table a:hover {
      text-decoration: underline;
    }

    .loader {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
    }
  </style>
</head>

<body>

  <div class="lang-switcher">
    <button data-lang="ru" class="active">RU</button>
    <button data-lang="en">EN</button>
    <button data-lang="ja">JP</button>
  </div>

  <div class="header">
    <img src="https://line-0707.github.io/Acts/source/icon.webp" alt="Site Icon">
    <div>
      <h1><a href="https://line-0707.github.io/Acts/index.html" id="site-title">ИНФОРМАЦИОННАЯ САЙТА</a></h1>
      <h2 id="site-subtitle">Сводка опубликованных документов и ресурсов</h2>
    </div>
  </div>

  <div id="table-container">
    <div class="loader">Loading data from Google Sheet...</div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1Rvr4RwirK8-ygKXG3Qyq6Bf4OvGZ7YjsxiAb4ZI2Xeo/gviz/tq?tqx=out:csv&sheet=Лист1';

    const translations = {
      ru: {
        title: 'ИНФОРМАЦИОННАЯ САЙТА',
        subtitle: 'Сводка опубликованных документов и ресурсов',
        headers: { date: 'дата', files: 'файлы', description: 'описание' }
      },
      en: {
        title: 'INFORMATION SITE',
        subtitle: 'Summary of published documents and resources',
        headers: { date: 'date', files: 'files', description: 'description' }
      },
      ja: {
        title: '情報サイト',
        subtitle: '公開されたドキュメントとリソースの概要',
        headers: { date: '日付', files: 'ファイル', description: '説明' }
      }
    };

    let fullData = [];
    let columnIndices = {};
    let visibleHeadersInfo = [];
    const columnsToHide = new Set(['en', 'jp', 'link', 'desc_en', 'desc_ja']);

    function parseCSV(csvText) {
      const rows = [];
      let currentRow = [];
      let currentCell = '';
      let inQuotes = false;
      csvText = csvText.replace(/\r\n/g, '\n');
      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        if (inQuotes) {
          if (char === '"' && i + 1 < csvText.length && csvText[i + 1] === '"') {
            currentCell += '"';
            i++;
          } else if (char === '"') {
            inQuotes = false;
          } else {
            currentCell += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            currentRow.push(currentCell);
            currentCell = '';
          } else if (char === '\n') {
            currentRow.push(currentCell);
            rows.push(currentRow);
            currentRow = [];
            currentCell = '';
          } else {
            currentCell += char;
          }
        }
      }
      if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell);
        rows.push(currentRow);
      }
      return rows;
    }

    function normalizeHeader(header) {
      // CSVから来た引用符を削除し、前後の空白を削除し、小文字に変換
      return header.trim().replace(/^"|"$/g, '').toLowerCase();
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.addEventListener('click', () => renderPage(button.dataset.lang));
      });
      fetchAndRender();
    });

    function fetchAndRender() {
      fetch(sheetUrl)
        .then(response => response.ok ? response.text() : Promise.reject('Network error'))
        .then(csvText => {
          fullData = parseCSV(csvText);
          if (fullData.length < 1) throw new Error('No data found');

          const headers = fullData[0];

          // --- デバッグ用：ヘッダーがどう認識されているか確認 ---
          const normalizedHeaders = headers.map(h => normalizeHeader(h));
          console.log("認識されたヘッダー名:", normalizedHeaders);
          // ---------------------------------------------

          headers.forEach((header, index) => {
            columnIndices[normalizeHeader(header)] = index;
          });

          visibleHeadersInfo = headers
            .map((header, index) => ({ header, index }))
            .filter(h => !columnsToHide.has(normalizeHeader(h.header)));

          renderPage('ru');
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('table-container').textContent = 'Error: Could not load data. Ensure the Google Sheet is "Published to the web" as a CSV.';
        });
    }

    function renderPage(lang) {
      document.getElementById('site-title').textContent = translations[lang].title;
      document.getElementById('site-subtitle').textContent = translations[lang].subtitle;
      document.documentElement.lang = lang;

      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.classList.toggle('active', button.dataset.lang === lang);
      });

      const tableContainer = document.getElementById('table-container');
      tableContainer.innerHTML = '';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      const translatedHeaders = translations[lang].headers;
      visibleHeadersInfo.forEach(({ header }) => {
        const th = document.createElement('th');
        th.textContent = translatedHeaders[normalizeHeader(header)] || header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      for (let i = 1; i < fullData.length; i++) {
        const rowData = fullData[i];
        if (rowData.length <= 1 && !rowData[0]) continue;

        if (rowData[0] && rowData[0].trim().startsWith('cat[')) {
          const match = rowData[0].trim().match(/\[(.*?)\]/);
          if (match) {
            const tr = document.createElement('tr');
            tr.className = 'category-row';
            const td = document.createElement('td');
            td.colSpan = visibleHeadersInfo.length;
            td.textContent = match[1];
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
        } else {
          const tr = document.createElement('tr');
          const linkUrl = rowData[columnIndices['link']];

          visibleHeadersInfo.forEach(({ header, index }) => {
            const td = document.createElement('td');
            let cellText;

            const normalizedHeader = normalizeHeader(header);

            if (normalizedHeader === 'files') {
              if (lang === 'en') cellText = rowData[columnIndices['en']];
              else if (lang === 'ja') cellText = rowData[columnIndices['jp']];
              else cellText = rowData[columnIndices['files']];
            } else if (normalizedHeader === 'description') {
              if (lang === 'en' && columnIndices['desc_en']) cellText = rowData[columnIndices['desc_en']];
              else if (lang === 'ja' && columnIndices['desc_ja']) cellText = rowData[columnIndices['desc_ja']];
              else cellText = rowData[index];
            } else {
              cellText = rowData[index];
            }

            cellText = (cellText || '').trim();

            if (normalizedHeader === 'files' && linkUrl) {
              const a = document.createElement('a');
              a.href = linkUrl;
              a.textContent = cellText;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              td.appendChild(a);
            } else {
              td.textContent = cellText;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      tableContainer.appendChild(table);
    }
  </script>

</body>

</html>