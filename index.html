<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ИНФОРМАЦИОННАЯ САЙТА</title>
  <link rel="icon" type="image/x-icon" href="https://line-0707.github.io/Acts/favicon.ico">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
      color: #333;
      position: relative;
    }

    /* --- ここが修正点です --- */
    .content-wrapper {
      max-width: 1280px;
      /* コンテンツの最大幅を指定 */
      margin: 0 auto;
      /* 左右の余白を自動で設定し、中央寄せにする */
    }

    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 5px;
      background-color: #fff;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .lang-switcher button {
      border: none;
      background-color: transparent;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
      color: #007bff;
      border-radius: 5px;
      transition: background-color 0.2s, color 0.2s;
    }

    .lang-switcher button:hover {
      background-color: #e9ecef;
    }

    .lang-switcher button.active {
      background-color: #007bff;
      color: white;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .header img {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }

    .header h1,
    .header h2 {
      margin: 0;
    }

    .header h1 {
      font-size: 2em;
    }

    .header h1 a {
      text-decoration: none;
      color: inherit;
    }

    .header h2 {
      font-size: 1.2em;
      font-weight: normal;
      color: #555;
    }

    #table-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      background-color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    thead th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    tbody tr:hover {
      background-color: #e9ecef;
    }

    .category-row td {
      background-color: #6c757d;
      color: white;
      font-weight: bold;
    }

    tr.category-row:hover {
      background-color: transparent;
    }

    tr.category-row:hover td {
      background-color: #6c757d;
    }

    table a {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    table a:hover {
      text-decoration: underline;
    }

    .loader {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
    }
  </style>
</head>

<body>

  <div class="lang-switcher">
    <button data-lang="ru" class="active">RU</button>
    <button data-lang="en">EN</button>
    <button data-lang="ja">JP</button>
  </div>

  <!-- --- ここが修正点です --- -->
  <div class="content-wrapper">
    <div class="header">
      <img src="https://line-0707.github.io/Acts/source/icon.webp" alt="Site Icon">
      <div>
        <h1><a href="https://line-0707.github.io/Acts/index.html" id="site-title">ИНФОРМАЦИОННАЯ САЙТА</a></h1>
        <h2 id="site-subtitle">Сводка опубликованных документов и ресурсов</h2>
      </div>
    </div>

    <div id="table-container">
      <div class="loader">Loading data from Google Sheet...</div>
    </div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1Rvr4RwirK8-ygKXG3Qyq6Bf4OvGZ7YjsxiAb4ZI2Xeo/gviz/tq?tqx=out:csv&sheet=Лист1';

    const translations = {
      ru: {
        title: 'ИНФОРМАЦИОННАЯ САЙТА',
        subtitle: 'Сводка опубликованных документов и ресурсов',
        headers: { date: 'дата', files: 'файлы', description: 'описание', status: 'статус', last_update: 'последнее обновление' },
        status_text: { g: 'Доступен', ex: 'Истек срок', e: 'В разработке' },
        months: ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь']
      },
      en: {
        title: 'INFORMATION SITE',
        subtitle: 'Summary of published documents and resources',
        headers: { date: 'date', files: 'files', description: 'description', status: 'status', last_update: 'last update' },
        status_text: { g: 'Available', ex: 'Expired', e: 'Incomplete' },
        months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
      },
      ja: {
        title: '情報サイト',
        subtitle: '公開されたドキュメントとリソースの概要',
        headers: { date: '日付', files: 'ファイル', description: '説明', status: '状態', last_update: '最終更新' },
        status_text: { g: '利用可能', ex: '期限切れ', e: '未完成' },
        months: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
      }
    };

    let fullData = [];
    let columnIndices = {};
    let visibleHeadersInfo = [];
    const columnsToHide = new Set(['en', 'jp', 'link', 'desc_en', 'desc_ja']);

    function parseCSV(csvText) {
      const lines = csvText.replace(/\r\n/g, '\n').split('\n');
      return lines.map(line => {
        const row = [];
        let cell = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"' && inQuotes) {
            if (i + 1 < line.length && line[i + 1] === '"') {
              cell += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else if (char === '"' && !inQuotes) {
            inQuotes = true;
          } else if (char === ',' && !inQuotes) {
            row.push(cell);
            cell = '';
          } else {
            cell += char;
          }
        }
        row.push(cell);
        return row;
      });
    }

    function normalizeHeader(header) {
      return (header || '').trim().replace(/^"|"$/g, '').toLowerCase();
    }

    function toFullWidth(str) {
      return String(str).replace(/[0-9]/g, s => String.fromCharCode(s.charCodeAt(0) + 0xFEE0));
    }

    function formatDate(dateString, lang) {
      if (!dateString) return dateString;
      const date = new Date(dateString.replace(/(\d+)\.(\d+)\.(\d+)/, '$2/$1/$3'));

      if (isNaN(date.getTime())) {
        if (/^\d{8}$/.test(dateString)) {
          const year = dateString.substring(0, 4);
          const month = dateString.substring(4, 6);
          const day = dateString.substring(6, 8);
          const newDate = new Date(year, month - 1, day);
          if (!isNaN(newDate.getTime())) return formatDate(newDate.toISOString(), lang);
        }
        return dateString;
      }

      const year = date.getFullYear();
      const monthIndex = date.getMonth();
      const day = date.getDate();

      switch (lang) {
        case 'ru':
          return `${day} ${translations.ru.months[monthIndex]} ${year}г.`;
        case 'en':
          return `${translations.en.months[monthIndex]} ${day}, ${year}`;
        case 'ja':
          return `${toFullWidth(year)}年${toFullWidth(monthIndex + 1)}月${toFullWidth(day)}日`;
        default:
          return dateString;
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.addEventListener('click', () => renderPage(button.dataset.lang));
      });
      fetchAndRender();
    });

    function fetchAndRender() {
      fetch(sheetUrl)
        .then(response => response.ok ? response.text() : Promise.reject('Network error'))
        .then(csvText => {
          fullData = parseCSV(csvText);
          if (fullData.length < 1) throw new Error('No data found');

          const firstRowRaw = fullData[0];
          if (firstRowRaw.length > 0 && firstRowRaw.some(cell => cell.includes('cat['))) {
            const correctedHeaders = [];
            const correctedFirstDataRow = [];
            firstRowRaw.forEach(cellContent => {
              const catIndex = cellContent.indexOf('cat[');
              if (catIndex !== -1) {
                correctedHeaders.push(cellContent.substring(0, catIndex).trim());
                correctedFirstDataRow.push(cellContent.substring(catIndex).trim());
              } else {
                const spaceIndex = cellContent.indexOf(' ');
                if (spaceIndex !== -1) {
                  correctedHeaders.push(cellContent.substring(0, spaceIndex).trim());
                  correctedFirstDataRow.push(cellContent.substring(spaceIndex + 1).trim());
                } else {
                  correctedHeaders.push(cellContent.trim());
                  correctedFirstDataRow.push('');
                }
              }
            });
            fullData.shift();
            fullData.unshift(correctedFirstDataRow);
            fullData.unshift(correctedHeaders);
          }

          const headers = fullData[0];
          const normalizedHeaders = headers.map(h => normalizeHeader(h));
          console.log("最終的に認識されたヘッダー名:", normalizedHeaders);

          headers.forEach((header, index) => {
            columnIndices[normalizeHeader(header)] = index;
          });

          visibleHeadersInfo = headers
            .map((header, index) => ({ header, index }))
            .filter(h => !columnsToHide.has(normalizeHeader(h.header)));

          renderPage('ru');
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('table-container').textContent = 'Error: Could not load data. Ensure the Google Sheet is "Published to the web" as a CSV.';
        });
    }

    function renderPage(lang) {
      document.getElementById('site-title').textContent = translations[lang].title;
      document.getElementById('site-subtitle').textContent = translations[lang].subtitle;
      document.documentElement.lang = lang;

      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.classList.toggle('active', button.dataset.lang === lang);
      });

      const tableContainer = document.getElementById('table-container');
      tableContainer.innerHTML = '';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      const translatedHeaders = translations[lang].headers;
      visibleHeadersInfo.forEach(({ header }) => {
        const th = document.createElement('th');
        th.textContent = translatedHeaders[normalizeHeader(header)] || header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      for (let i = 1; i < fullData.length; i++) {
        const rowData = fullData[i];
        if (rowData.length <= 1 && !(rowData[0] || '').trim()) continue;

        let fileCellText = '';
        const ruFileText = (rowData[columnIndices['files']] || '').trim();
        if (lang === 'en') {
          fileCellText = (rowData[columnIndices['en']] || ruFileText).trim();
        } else if (lang === 'ja') {
          fileCellText = (rowData[columnIndices['jp']] || ruFileText).trim();
        } else {
          fileCellText = ruFileText;
        }

        if (fileCellText.startsWith('cat[')) {
          const match = fileCellText.match(/\[(.*?)\]/);
          if (match) {
            const tr = document.createElement('tr');
            tr.className = 'category-row';
            const td = document.createElement('td');
            td.colSpan = visibleHeadersInfo.length;
            td.textContent = match[1];
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
        } else {
          const tr = document.createElement('tr');
          const linkUrl = (rowData[columnIndices['link']] || '').trim();

          visibleHeadersInfo.forEach(({ header, index }) => {
            const td = document.createElement('td');
            let cellText;
            const normalizedHeader = normalizeHeader(header);

            if (normalizedHeader === 'files') {
              cellText = fileCellText;
            } else if (normalizedHeader === 'description') {
              const ruDescText = (rowData[columnIndices['description']] || '').trim();
              if (lang === 'en') cellText = (rowData[columnIndices['desc_en']] || ruDescText).trim();
              else if (lang === 'ja') cellText = (rowData[columnIndices['desc_ja']] || ruDescText).trim();
              else cellText = ruDescText;
            } else if (normalizedHeader === 'status') {
              const statusCode = (rowData[index] || '').trim().toLowerCase();
              let statusConfig = null;

              switch (statusCode) {
                case 'g':
                  statusConfig = { text: translations[lang].status_text.g, bgColor: '#d1fae5', color: '#065f46', bulletColor: '#16a34a' };
                  break;
                case 'ex':
                  statusConfig = { text: translations[lang].status_text.ex, bgColor: '#fecaca', color: '#991b1b', bulletColor: '#dc2626' };
                  break;
                case 'e':
                  statusConfig = { text: translations[lang].status_text.e, bgColor: '#fef9c3', color: '#92400e', bulletColor: '#f59e0b' };
                  break;
              }

              if (statusConfig) {
                const bulletSpan = document.createElement('span');
                bulletSpan.textContent = '● ';
                bulletSpan.style.color = statusConfig.bulletColor;

                const textSpan = document.createElement('span');
                textSpan.textContent = statusConfig.text;
                textSpan.style.fontWeight = 'bold';

                td.appendChild(bulletSpan);
                td.appendChild(textSpan);

                td.style.backgroundColor = statusConfig.bgColor;
                td.style.color = statusConfig.color;
              } else {
                td.textContent = (rowData[index] || '').trim();
              }
              tr.appendChild(td);
              return;

            } else if (normalizedHeader === 'last_update') {
              cellText = formatDate((rowData[index] || '').trim(), lang);
            } else {
              cellText = (rowData[index] || '').trim();
            }

            if (normalizedHeader === 'files' && linkUrl) {
              const a = document.createElement('a');
              a.href = linkUrl;
              a.textContent = cellText;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              td.appendChild(a);
            } else {
              td.textContent = cellText;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      tableContainer.appendChild(table);
    }
  </script>

</body>

</html>