<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="darkreader-lock">
  <title>ИНФОРМАЦИОННАЯ САЙТА</title>
  <link rel="icon" type="image/x-icon" href="https://line-0707.github.io/Acts/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="common.css">
  <style>
    /* index.html 専用のスタイル */
    #table-container {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      background-color: var(--card-bg-color);
    }
    table { width: 100%; border-collapse: collapse; display: table; }
    thead, tbody { display: block; }
    tr { display: flex; align-items: stretch; }
    th, td {
      padding: 12px 15px; text-align: left;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0; white-space: normal; word-break: break-word;
      display: flex; align-items: center;
    }
    .th-files, .td-files { flex: 1 1 auto; }
    .th-description, .td-description { flex: 0 1 25%; }
    .th-date, .td-date { flex: 0 0 16%; }
    .th-status, .td-status { flex: 0 0 18%; }
    .th-last_update, .td-last_update { flex: 0 0 20%; order: 99; }
    thead th { background-color: var(--header-bg-color); color: white; font-weight: bold; border-bottom: 1px solid var(--header-bg-color); }
    tbody tr:nth-child(even) { background-color: var(--even-row-bg-color); }
    tbody tr:hover { background-color: var(--hover-bg-color); }
    .category-row { display: block; }
    .category-row td {
      background-color: var(--category-bg-color);
      color: white; font-weight: bold;
      width: 100%;
      box-sizing: border-box;
    }
    tr.category-row:hover td { background-color: var(--category-hover-bg-color); }
    .loader { text-align: center; padding: 20px; font-size: 1.2em; }
    .status-bullet-mobile { display: none; }
    
    @media (max-width: 768px) {
        .status-text, .th-status, .td-status { display: none; }
        .status-bullet-mobile { display: inline; font-weight: bold; }
        .th-files, .td-files { flex: 1 1 auto; }
        .th-date, .td-date { flex: 0 0 25%; }
        .th-description, .td-description { flex: 0 0 15%; }
        .th-last_update, .td-last_update { flex: 0 0 30%; order: 99; }
    }
  </style>
</head>

<body>

  <div class="content-wrapper">
    <div class="top-controls">
        <button id="theme-toggle" class="control-button" title="Toggle theme"></button>
        <div class="lang-switcher">
          <button data-lang="ru" class="control-button active">RU</button>
          <button data-lang="en" class="control-button">EN</button>
          <button data-lang="ja" class="control-button">JP</button>
        </div>
    </div>
    <div class="header">
      <a href="https://line-0707.github.io/Acts/index.html">
        <img src="https://line-0707.github.io/Acts/source/icon.webp" alt="Site Icon">
      </a>
      <div>
        <h1><a href="https://line-0707.github.io/Acts/index.html" id="site-title"></a></h1>
        <h2 id="site-subtitle"></h2>
      </div>
    </div>
    <div id="table-container">
      <div class="loader">Loading data from Google Sheet...</div>
    </div>
    <footer>
        <p id="site-last-updated"></p>
    </footer>
  </div>

  <script src="common.js"></script>
  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1Rvr4RwirK8-ygKXG3Qyq6Bf4OvGZ7YjsxiAb4ZI2Xeo/gviz/tq?tqx=out:csv&sheet=Лист1';

    const translations = {
      ru: {
        title: 'ИНФОРМАЦИОННАЯ САЙТА',
        subtitle: 'Сводка опубликованных документов и ресурсов',
        headers: { date: 'дата', files: 'файлы', description: 'описание', status: 'статус', last_update: 'последнее обновление' },
        status_text: { g: 'Доступен', ex: 'Истек срок', e: 'В разработке', b: 'Скрытый' },
        months_short: ['янв', 'фев', 'мар', 'апр', 'мая', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'],
        site_last_updated: 'Последнее обновление сайта:'
      },
      en: {
        title: 'INFORMATION SITE',
        subtitle: 'Summary of published documents and resources',
        headers: { date: 'date', files: 'files', description: 'description', status: 'status', last_update: 'last update'},
        status_text: { g: 'Available', ex: 'Expired', e: 'Incomplete', b: 'Private' },
        months_short: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        site_last_updated: 'Site last updated:'
      },
      ja: {
        title: '情報サイト',
        subtitle: '公開されたドキュメントとリソースの概要',
        headers: { date: '日付', files: 'ファイル', description: '説明', status: '状態', last_update: '最終更新'},
        status_text: { g: '利用可能', ex: '期限切れ', e: '未完成', b: '非公開' },
        site_last_updated: 'サイト最終更新日時:'
      }
    };

    let fullData = [];
    let columnIndices = {};
    let visibleHeadersInfo = [];
    const columnsToHide = new Set(['en', 'jp', 'link', 'desc_en', 'desc_ja']);
    let siteLastModifiedDate = null;

    function parseCSV(csvText) {
        const lines = csvText.replace(/\r\n/g, '\n').split('\n');
        return lines.map(line => {
            const row = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && inQuotes) {
                    if (i + 1 < line.length && line[i + 1] === '"') { cell += '"'; i++; } else { inQuotes = false; }
                } else if (char === '"' && !inQuotes) { inQuotes = true;
                } else if (char === ',' && !inQuotes) { row.push(cell); cell = '';
                } else { cell += char; }
            }
            row.push(cell);
            return row;
        });
    }

    function normalizeHeader(header) { return (header || '').trim().replace(/^"|"$/g, '').toLowerCase(); }
    
    function formatDate(dateString, lang, useShort = false) {
        if (!dateString || typeof dateString !== 'string') return dateString;
        let date;
        if (/^\d{8}$/.test(dateString)) {
            const year = dateString.substring(0, 4), month = dateString.substring(4, 6), day = dateString.substring(6, 8);
            date = new Date(year, month - 1, day);
        } else if (/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/.test(dateString)) {
            const parts = dateString.split('.');
            date = new Date(parts[2], parts[1] - 1, parts[0]);
        } else {
            date = new Date(dateString);
        }
        if (isNaN(date.getTime())) { return dateString; }

        if (lang === 'ja') {
            const isMobile = window.innerWidth <= 768;
            const options = { era: isMobile ? 'narrow' : 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Intl.DateTimeFormat('ja-JP-u-ca-japanese', options).format(date);
        }
        
        const year = date.getFullYear(), monthIndex = date.getMonth(), day = date.getDate();
        const monthArray = useShort ? translations[lang].months_short : (translations[lang].months || translations.en.months);

        switch (lang) {
            case 'ru': return `${day} ${monthArray[monthIndex]} ${year}г.`;
            case 'en': return `${monthArray[monthIndex]} ${day}, ${year}`;
            default: return date.toLocaleDateString();
        }
    }
    
    function getStatusConfig(statusCode, lang, isDarkMode) {
        let colors = null;
        switch (statusCode) {
            case 'g': 
                colors = { light: '#d1fae5', dark: '#065f46', bullet: '#16a34a' };
                break;
            case 'ex': 
                colors = { light: '#fecaca', dark: '#991b1b', bullet: '#dc2626' };
                break;
            case 'e': 
                colors = { light: '#fef9c3', dark: '#92400e', bullet: '#f59e0b' };
                break;
            case 'b':
                colors = { light: '#e5e7eb', dark: '#374151', bullet: '#6b7280' };
                break;
            default: return null;
        }
        return {
            text: translations[lang].status_text[statusCode],
            bgColor: isDarkMode ? colors.dark : colors.light,
            color: isDarkMode ? colors.light : colors.dark,
            bulletColor: colors.bullet
        };
    }

    // --- ここからが修正点です ---
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.lang-switcher button').forEach(button => {
        button.addEventListener('click', () => {
          const newLang = button.dataset.lang;
          localStorage.setItem('lang', newLang); // 言語設定を保存
          renderPage(newLang);
        });
      });
      fetchAndRender();
    });

    function fetchAndRender() {
      const dataPromise = fetch(sheetUrl).then(res => res.ok ? res.text() : Promise.reject('Data fetch failed'));
      const siteHeadersPromise = fetch(window.location.href, { method: 'HEAD' })
          .then(res => {
              if (res.ok && res.headers.has('Last-Modified')) {
                  siteLastModifiedDate = new Date(res.headers.get('Last-Modified'));
              }
          }).catch(err => console.error("Could not fetch site last modified date:", err));

      Promise.all([dataPromise, siteHeadersPromise])
        .then(([csvText]) => {
          fullData = parseCSV(csvText);
          if (fullData.length < 1) throw new Error('No data found');
          const firstRowRaw = fullData[0];
          if (firstRowRaw.length > 0 && firstRowRaw.some(cell => cell.includes('cat['))) {
              const correctedHeaders = [], correctedFirstDataRow = [];
              firstRowRaw.forEach(cellContent => {
                  const catIndex = cellContent.indexOf('cat[');
                  if (catIndex !== -1) {
                      correctedHeaders.push(cellContent.substring(0, catIndex).trim());
                      correctedFirstDataRow.push(cellContent.substring(catIndex).trim());
                  } else {
                      const spaceIndex = cellContent.indexOf(' ');
                      if (spaceIndex !== -1) {
                          correctedHeaders.push(cellContent.substring(0, spaceIndex).trim());
                          correctedFirstDataRow.push(cellContent.substring(spaceIndex + 1).trim());
                      } else {
                          correctedHeaders.push(cellContent.trim());
                          correctedFirstDataRow.push('');
                      }
                  }
              });
              fullData.shift(); fullData.unshift(correctedFirstDataRow); fullData.unshift(correctedHeaders);
          }
          const headers = fullData[0];
          console.log("最終的に認識されたヘッダー名:", headers.map(h => normalizeHeader(h)));
          headers.forEach((header, index) => { columnIndices[normalizeHeader(header)] = index; });
          visibleHeadersInfo = headers.map((header, index) => ({ header, index })).filter(h => !columnsToHide.has(normalizeHeader(h.header)));
          
          const savedLang = localStorage.getItem('lang') || 'ru'; // 保存された言語を読み込む
          renderPage(savedLang);
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('table-container').textContent = 'Error: Could not load data. Ensure the Google Sheet is "Published to the web" as a CSV.';
        });
    }
    // --- ここまで ---

    function renderPage(lang) {
      document.getElementById('site-title').textContent = translations[lang].title;
      document.getElementById('site-subtitle').textContent = translations[lang].subtitle;
      document.documentElement.lang = lang;
      const isMobile = window.innerWidth <= 768;
      const isDarkMode = document.body.classList.contains('dark-mode');
      document.querySelectorAll('.lang-switcher button').forEach(button => { button.classList.toggle('active', button.dataset.lang === lang); });
      const tableContainer = document.getElementById('table-container');
      if (fullData.length === 0) return;
      tableContainer.innerHTML = '';
      const table = document.createElement('table'), thead = document.createElement('thead'), tbody = document.createElement('tbody');
      const headerRow = document.createElement('tr');
      const translatedHeaders = translations[lang].headers;
      visibleHeadersInfo.forEach(({ header }) => {
        const th = document.createElement('th'), normalizedHeader = normalizeHeader(header);
        th.className = 'th-' + normalizedHeader;
        th.textContent = translatedHeaders[normalizedHeader] || header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      for (let i = 1; i < fullData.length; i++) {
        const rowData = fullData[i];
        if (rowData.length <= 1 && !(rowData[0] || '').trim()) continue;
        let fileCellText = '';
        const ruFileText = (rowData[columnIndices['files']] || '').trim();
        if (lang === 'en') { fileCellText = (rowData[columnIndices['en']] || ruFileText).trim();
        } else if (lang === 'ja') { fileCellText = (rowData[columnIndices['jp']] || ruFileText).trim();
        } else { fileCellText = ruFileText; }
        if (fileCellText.startsWith('cat[')) {
          const match = fileCellText.match(/\[(.*?)\]/);
          if (match) {
            const tr = document.createElement('tr');
            tr.className = 'category-row';
            const td = document.createElement('td');
            td.colSpan = visibleHeadersInfo.length; td.textContent = match[1];
            tr.appendChild(td); tbody.appendChild(tr);
          }
        } else {
          const tr = document.createElement('tr');
          const linkUrl = (rowData[columnIndices['link']] || '').trim();
          const statusCode = (rowData[columnIndices['status']] || '').trim().toLowerCase();
          const statusConfig = getStatusConfig(statusCode, lang, isDarkMode);
          visibleHeadersInfo.forEach(({ header, index }) => {
            const td = document.createElement('td');
            let cellText;
            const normalizedHeader = normalizeHeader(header);
            td.className = 'td-' + normalizedHeader;
            if (normalizedHeader === 'files') { cellText = fileCellText;
            } else if (normalizedHeader === 'description') {
              const ruDescText = (rowData[columnIndices['description']] || '').trim();
              if (lang === 'en') cellText = (rowData[columnIndices['desc_en']] || ruDescText).trim();
              else if (lang === 'ja') cellText = (rowData[columnIndices['desc_ja']] || ruDescText).trim();
              else cellText = ruDescText;
            } else if (normalizedHeader === 'status') {
              if (statusConfig) {
                  const bulletSpan = document.createElement('span'); bulletSpan.textContent = '● '; bulletSpan.style.color = statusConfig.bulletColor;
                  const textSpan = document.createElement('span'); textSpan.className = 'status-text'; textSpan.textContent = statusConfig.text; textSpan.style.fontWeight = 'bold';
                  td.appendChild(bulletSpan); td.appendChild(textSpan);
                  td.style.backgroundColor = statusConfig.bgColor; td.style.color = statusConfig.color;
              } else { td.textContent = (rowData[index] || '').trim(); }
              tr.appendChild(td); return;
            } else if (normalizedHeader === 'last_update') {
                cellText = formatDate((rowData[index] || '').trim(), lang, isMobile);
            } else {
              cellText = formatDate((rowData[index] || '').trim(), lang, false);
            }
            if (normalizedHeader === 'files') {
                const contentWrapper = document.createDocumentFragment();
                if (statusConfig) {
                    const bulletSpan = document.createElement('span'); bulletSpan.className = 'status-bullet-mobile'; bulletSpan.textContent = '● '; bulletSpan.style.color = statusConfig.bulletColor;
                    contentWrapper.appendChild(bulletSpan);
                }
                const a = document.createElement('a');
                a.textContent = cellText;
                if (linkUrl) {
                    if (linkUrl.toLowerCase().endsWith('.pdf')) {
                        const viewerUrl = 'pdfviewer/web/viewer.html';
                        a.href = `${viewerUrl}?file=${encodeURIComponent(linkUrl)}`;
                    } else {
                        a.href = linkUrl;
                    }
                    // --- ここが修正点です ---
                    // a.target = '_blank'; // この行を削除
                    a.rel = 'noopener noreferrer';
                }
                contentWrapper.appendChild(a);
                td.appendChild(contentWrapper);

            } else { td.textContent = cellText; }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      }
      table.appendChild(thead); table.appendChild(tbody);
      tableContainer.appendChild(table);

      if (siteLastModifiedDate) {
        const locale = lang === 'ja' ? 'ja-JP-u-ca-japanese' : `${lang}-${lang.toUpperCase()}`;
        const dateTimeOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const formattedDateTime = new Intl.DateTimeFormat(locale, dateTimeOptions).format(siteLastModifiedDate);
        document.getElementById('site-last-updated').textContent = `${translations[lang].site_last_updated} ${formattedDateTime}`;
      }
    }
  </script>

</body>

</html>